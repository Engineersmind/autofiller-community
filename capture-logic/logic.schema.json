{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://autofiller.dev/schemas/capture-logic.schema.json",
  "title": "Autofiller Capture Logic Schema",
  "description": "Schema for defining PDF-to-form field mapping and transformation rules",
  "type": "object",
  "required": ["id", "name", "mappings"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Unique identifier for the capture pattern"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name"
    },
    "description": {
      "type": "string",
      "description": "Description of what this pattern does"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version"
    },
    "source_pack": {
      "type": "string",
      "description": "Domain pack this pattern works with"
    },
    "target_form": {
      "type": "string",
      "description": "Target form identifier"
    },
    "mappings": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/fieldMapping"
      },
      "description": "Field mappings from source to target"
    },
    "transforms": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/transformRule"
      },
      "description": "Custom transformation rules"
    },
    "validations": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/validationRule"
      },
      "description": "Validation rules for filled fields"
    },
    "computed": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/computedField"
      },
      "description": "Fields calculated from other fields"
    },
    "defaults": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/defaultValue"
      },
      "description": "Default values for fields"
    },
    "conditionals": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/conditionalRule"
      },
      "description": "Conditional logic for field filling"
    }
  },
  "definitions": {
    "fieldMapping": {
      "type": "object",
      "required": ["source", "target"],
      "properties": {
        "source": {
          "type": "string",
          "description": "Source field from extracted data"
        },
        "target": {
          "type": "string",
          "description": "Target form field"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether this mapping is required"
        },
        "transform": {
          "type": "string",
          "description": "Transform to apply to value"
        },
        "validation": {
          "type": "string",
          "description": "Validation rule to apply"
        },
        "fallback": {
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "value": {
                  "description": "Static fallback value"
                },
                "compute": {
                  "type": "string",
                  "description": "Computed fallback value"
                },
                "source": {
                  "type": "string",
                  "description": "Alternative source field"
                }
              }
            }
          ],
          "description": "Fallback if source is missing"
        },
        "when": {
          "type": "object",
          "properties": {
            "condition": {
              "type": "string",
              "description": "Condition expression"
            }
          },
          "description": "Conditional mapping"
        }
      }
    },
    "transformRule": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Transform identifier"
        },
        "type": {
          "type": "string",
          "enum": ["date", "number", "currency", "text", "address", "phone", "custom"],
          "description": "Transform type"
        },
        "input_formats": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Accepted input formats"
        },
        "output_format": {
          "type": "string",
          "description": "Output format"
        },
        "decimal_places": {
          "type": "integer",
          "description": "For number types, decimal precision"
        },
        "remove_symbols": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Symbols to remove from input"
        },
        "custom_function": {
          "type": "string",
          "description": "For custom type, function reference"
        }
      }
    },
    "validationRule": {
      "type": "object",
      "required": ["field"],
      "properties": {
        "field": {
          "type": "string",
          "description": "Field to validate"
        },
        "type": {
          "type": "string",
          "enum": ["required", "pattern", "range", "enum", "length", "custom"],
          "description": "Validation type"
        },
        "pattern": {
          "type": "string",
          "description": "Regex pattern for pattern type"
        },
        "min": {
          "type": "number",
          "description": "Minimum value for range type"
        },
        "max": {
          "type": "number",
          "description": "Maximum value for range type"
        },
        "values": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Allowed values for enum type"
        },
        "min_length": {
          "type": "integer",
          "description": "Minimum length for length type"
        },
        "max_length": {
          "type": "integer",
          "description": "Maximum length for length type"
        },
        "error": {
          "type": "string",
          "description": "Error message if validation fails"
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "object"
          },
          "description": "Multiple validation rules"
        }
      }
    },
    "computedField": {
      "type": "object",
      "required": ["field", "formula"],
      "properties": {
        "field": {
          "type": "string",
          "description": "Target field name"
        },
        "formula": {
          "type": "string",
          "description": "Computation formula"
        },
        "dependencies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Fields this computation depends on"
        }
      }
    },
    "defaultValue": {
      "type": "object",
      "required": ["field", "value"],
      "properties": {
        "field": {
          "type": "string",
          "description": "Field to set default for"
        },
        "value": {
          "description": "Default value"
        },
        "when": {
          "type": "object",
          "properties": {
            "condition": {
              "type": "string",
              "description": "Condition for applying default"
            }
          }
        }
      }
    },
    "conditionalRule": {
      "type": "object",
      "required": ["condition", "then"],
      "properties": {
        "condition": {
          "type": "string",
          "description": "Condition expression"
        },
        "then": {
          "type": "object",
          "description": "Actions if condition is true"
        },
        "else": {
          "type": "object",
          "description": "Actions if condition is false"
        }
      }
    }
  }
}
